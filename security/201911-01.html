<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; form-action 'self'; object-src 'none'; script-src 'self'; style-src 'self'; font-src 'self'; connect-src 'self'; img-src 'self' data:; base-uri 'none'">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff">
  <meta name="referrer" content="same-origin" />

  <title>SSPSA 201911-01: Signature validation bypass - SimpleSAMLphp</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201911-01.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form class="searchbox" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> » SSPSA 201911-01: Signature validation bypass</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/support/">Support</a>
      </div>
      <div class="menuitem last">
        <a href="/contrib/">Contribute</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px">
    <br style="height: 0px; clear: both">
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning right">
<h2>Date</h2>
November 7, 2019
<h2>Affected versions</h2>
<code>robrichards/xmlseclibs &lt;= 3.0.3</code><br />
<code>robrichards/xmlseclibs &lt;= 2.1.0</code><br />
<code>robrichards/xmlseclibs &lt;= 1.4.2</code><br />
<code>SimpleSAMLphp &lt;= 1.17.6</code><br />
<code>simplesamlphp/saml2 &lt;= 4.1.0</code><br />
<code>simplesamlphp/saml2 &lt;= 3.4.1</code><br />
<code>simplesamlphp/saml2 &lt;= 2.3.8</code>
<h2>Severity</h2>
Critical
<h2>References</h2>
CVE-2019-3465
</div></aside>

<h1 id="201911-01">201911-01</h1>

<p><strong>Signature validation bypass</strong></p>

<h3 id="background">Background</h3>

<p>XMLSecLibs is a library written by Rob Richards that implements the
<a href="https://www.w3.org/TR/2002/REC-xmlenc-core-20021210/Overview.html">xml-enc</a> and
<a href="https://www.w3.org/TR/xmldsig-core1/">xml-dsig</a> W3C recommendations. It allows its users to handle encrypted and
digitally signed XML documents. SimpleSAMLphp delegates encryption and signature handling to this library.</p>

<h3 id="description">Description</h3>

<p>Producing a digital signature over an XML document or part of it is a complex set of steps that must be performed one
after the other:</p>

<ol>
  <li>First, the signed element, in this case a SAML assertion, needs to be canonicalized (that is, computing a unique
version of the XML independent of formatting).</li>
  <li>The canonicalized version of the signed element is then passed to a hash or digest algorithm, which computes a
fixed-length, non-reversible, deterministic representation of the original string.</li>
  <li>This digest is then included in a <code class="language-plaintext highlighter-rouge">Reference</code> element, which is in turn placed inside a <code class="language-plaintext highlighter-rouge">SignedInfo</code> element. This
<code class="language-plaintext highlighter-rouge">Reference</code> element is actually referring to the XML element that is being signed, by means of its <code class="language-plaintext highlighter-rouge">URI</code> attribute.
The value of this <code class="language-plaintext highlighter-rouge">URI</code> attribute is essentially an URI matching the identifier (<code class="language-plaintext highlighter-rouge">ID</code>) of the element.</li>
  <li>The entire <code class="language-plaintext highlighter-rouge">SignedInfo</code> element is also canonicalized.</li>
  <li>The canonicalized <code class="language-plaintext highlighter-rouge">SignedInfo</code> is then fed to a cryptographic algorithm using the private key belonging to the entity
signing the piece of XML. The output of this algorithm is stored as the content of the <code class="language-plaintext highlighter-rouge">SignatureValue</code> element, which
is included as the next child of the top <code class="language-plaintext highlighter-rouge">Signature</code> XML element.</li>
  <li>Finally, depending on the type of XML signature, this <code class="language-plaintext highlighter-rouge">Signature</code> element is either provided as a detached document
or enveloped inside the actual signed XML document.</li>
</ol>

<p>For signature validation, the process is similar, although the <code class="language-plaintext highlighter-rouge">SignatureValue</code> is validated with the public key of
the signing entity, and the result is then compared to the digest computed over the canonicalized element whose
signature is being validated. All the steps in the validation procedure must be taken carefully to ensure that we are
inspecting the right elements of the XML document.</p>

<p>There are multiple ways to locate elements inside an XML document, and a very popular one, used by XMLSecLibs, is the
query language known as <strong>XPath</strong> (<em>XML Path Language</em>). XPath allows to retrieve elements from an XML document by
writing expressions. These expressions can be either relative or absolute to the root of the document, and they can
match one or multiple elements at the same time. If an expression is not written carefully, it might select multiple
elements at the same time, even though that wasn’t expected.</p>

<p>The issue at hand is rooted at the way XPath expressions are used by XMLSecLibs to select <code class="language-plaintext highlighter-rouge">Reference</code> elements inside of
<code class="language-plaintext highlighter-rouge">SignedInfo</code>. The XPath expression ` ./secdsig:SignedInfo/secdsig:Reference<code class="language-plaintext highlighter-rouge"> will select multiple </code>Reference<code class="language-plaintext highlighter-rouge"> elements
inside a </code>SignedInfo` element from the current element, as in the following example:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Signature&gt;
  &lt;SignedInfo&gt;
    &lt;Reference URI="#1"&gt;...&lt;/Reference&gt;
    &lt;Reference URI="#2"&gt;...&lt;/Reference&gt;
  &lt;/SignedInfo&gt;
&lt;/Signature&gt;
</code></pre></div></div>

<p>However, it will also select multiple <code class="language-plaintext highlighter-rouge">Reference</code> elements from different <code class="language-plaintext highlighter-rouge">SignedInfo</code> elements when all of them are
children of the current element:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;Signature&gt;
  &lt;SignedInfo&gt;
    &lt;Reference URI="#1"&gt;...&lt;/Reference&gt;
  &lt;/SignedInfo&gt;
  &lt;SignedInfo&gt;
    &lt;Reference URI="#2"&gt;...&lt;/Reference&gt;
  &lt;/SignedInfo&gt;
&lt;/Signature&gt;
</code></pre></div></div>

<p>The resulting set of <code class="language-plaintext highlighter-rouge">Reference</code> elements is the same with such XPath expression and the given documents. XMLSecLibs
iterates over the list of references and processes all of them, adding them to a list of validated nodes. When the
signature is computed, only the first <code class="language-plaintext highlighter-rouge">SignedInfo</code> element (canonicalized) will be taken into account, though. If the
original signed element is kept in a different part of the XML document, the original <code class="language-plaintext highlighter-rouge">SignedInfo</code> will still validate.
However, a modified assertion taking the place of the original can now also be validated if an unsigned reference to it
is included in a new <code class="language-plaintext highlighter-rouge">SignedInfo</code> element that will be processed by XMLSecLibs, due to the previous XPath expression.</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All XMLSecLibs versions 1.x, 2.x and 3.x are affected, up to (including) <strong>1.4.2</strong>, <strong>2.1.0</strong> and
<strong>3.0.3</strong>, respectively.</p>

<p>All SimpleSAMLphp versions are affected, up to (including) <strong>1.17.6</strong>.</p>

<h3 id="impact">Impact</h3>

<p>An attacker could leverage this issue to manually craft an assertion and have the message validated as correctly
signed without access to the signing key. This message will then be consumed by a SimpleSAMLphp service provider and
the malicious assertion will be processed as if it was legal.</p>

<p>The attacker needs, however, to be able to generate a valid SAML response issued by the targeted identity provider. This
means the attacker must be in possession of an account in that IdP. While this can be seen as a mitigation, it should be
noted that there is no limitation for an attacker in terms of what to include in the malicious assertion. Therefore, it
is possible to impersonate any identity at the targeted IdP once the attacker has any kind of account there.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the latest versions of the library, <strong>3.0.4</strong> or <strong>2.1.1</strong>.</p>

<p>For SimpleSAMLphp users, run <code class="language-plaintext highlighter-rouge">composer update</code> or upgrade to SimpleSAMLphp <strong>1.17.7</strong>. Refer to the documentation for
instructions on how to <a href="https://simplesamlphp.org/docs/stable/simplesamlphp-install-repo">run composer</a>.</p>

<p>For those using the <code class="language-plaintext highlighter-rouge">simplesamlphp/saml2</code> library directly, <code class="language-plaintext highlighter-rouge">run composer update</code> to upgrade to the latest version of
the library.</p>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered by Juraj Somorovsky and Karsten Meyer zu Selhausen (Hackmanit) during a security
audit commissioned by SURFnet, and reported on October 24, 2019. Additional details can be found in a
<a href="https://www.hackmanit.de/en/blog-en/82-xml-signature-validation-bypass-in-simplesamlphp-and-xmlseclibs">blog post</a> written
by Hackmanit.</p>

    </main>

<footer>
        <img class="logo" src="/res/ssplogo-fish-2.svg" alt="">
</footer>

  </body>
</html>
