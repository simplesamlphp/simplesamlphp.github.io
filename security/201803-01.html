<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta http-equiv="Content-Security-Policy" content="default-src 'none'; form-action 'self'; object-src 'none'; script-src 'self'; style-src 'self'; font-src 'self'; connect-src 'self'; img-src 'self' data:; base-uri 'none'">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8; X-Content-Type-Options=nosniff">
  <meta name="referrer" content="same-origin" />

  <title>SSPSA 201803-01: Incorrect signature verification - SimpleSAMLphp</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201803-01.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form class="searchbox" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> Â» SSPSA 201803-01: Incorrect signature verification</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/support/">Support</a>
      </div>
      <div class="menuitem last">
        <a href="/contrib/">Contribute</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px">
    <br style="height: 0px; clear: both">
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning right">
<h2>Date</h2>
March 2, 2018
<h2>Affected versions</h2>
<code>simplesamlphp/saml2 &lt; 3.1.4</code><br />
<code>simplesamlphp/saml2 &lt; 2.3.8</code><br />
<code>simplesamlphp/saml2 &lt; 1.10.6</code><br />
<code>SimpleSAMLphp &lt; 1.15.4</code>
<h2>Severity</h2>
Medium
<h2>References</h2>
CVE-2018-7711
</div></aside>

<h1 id="201803-01">201803-01</h1>

<p><strong>Incorrect signature verification</strong></p>

<h3 id="background">Background</h3>

<p>An incorrect check of return values in the signature validation utilities allows an attacker to get invalid signatures
accepted as valid by forcing an error during validation.</p>

<h3 id="description">Description</h3>

<p>The <code class="language-plaintext highlighter-rouge">HTTPRedirect</code> class of the SAML2 library has a method called <code class="language-plaintext highlighter-rouge">validateSignature()</code> that allows the verification of
the XML digital signature of a SAML 2 message with a given key. This method uses the <code class="language-plaintext highlighter-rouge">verifySignature()</code> method from
the <code class="language-plaintext highlighter-rouge">XMLSecurityKey</code> class to verify the signature with the given key, which in turn will
end up calling <code class="language-plaintext highlighter-rouge">openssl_verify()</code> depending on the signature algorithm used.</p>

<p>The <code class="language-plaintext highlighter-rouge">openssl_verify()</code> function returns <code class="language-plaintext highlighter-rouge">1</code> when the signature was successfully verified, <code class="language-plaintext highlighter-rouge">0</code> if it failed to verify
with the given key, and <code class="language-plaintext highlighter-rouge">-1</code> in case an error occurs. PHP allows translating numerical values to <em>boolean</em> implicitly,
with the following correspondences:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">0</code> equals <code class="language-plaintext highlighter-rouge">false</code>.</li>
  <li>Non-zero equals <code class="language-plaintext highlighter-rouge">true</code>.</li>
</ul>

<p>This means that an implicit conversion to boolean of the values returned by <code class="language-plaintext highlighter-rouge">openssl_verify()</code> will convert an error
state, signaled by the value <code class="language-plaintext highlighter-rouge">-1</code>, to a successful verification of the signature (represented by the boolean <code class="language-plaintext highlighter-rouge">true</code>).</p>

<p>The aforementioned method was performing an implicit conversion to boolean of the values returned
by the <code class="language-plaintext highlighter-rouge">verifySignature()</code> method, which subsequently will return the same output as <code class="language-plaintext highlighter-rouge">openssl_verify()</code> under most
circumstances. This means an error during signature verification is treated as a successful verification by the method.</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All <strong>simplesamlphp/saml2</strong> versions 0.x, 1.x, 2.x and 3.x are affected, up to (including) <strong>1.10.5</strong>, <strong>2.3.7</strong> and
<strong>3.1.3</strong>.</p>

<p>All SimpleSAMLphp versions are affected, up to (including) <strong>1.15.3</strong>.</p>

<h3 id="impact">Impact</h3>

<p>Upon successful exploitation, an invalid signature would be regarded as valid by an affected version of the software.
This allows attackers to modify or manually craft <strong>SAML 2 messages</strong> and, by triggering a signature validation
error in the affected party, get those messages accepted as valid and coming from a trusted entity. In practice, this
means full capabilities to impersonate any individual at a given service provider.</p>

<p>The issue can be exploited to get other invalid messages accepted as valid, though the security implications there are
minor.</p>

<p>In order to exploit the issue, <strong>SAML 2 metadata must be registered by the vulnerable Service Provider for the
Identity Provider targeted by the attacker</strong> (in <code class="language-plaintext highlighter-rouge">metadata/shib20-idp-remote.php</code>), and an incorrect context must be fed
to the signature validation routines, or an exceptional error must be triggered. So far, the following cases have been
identified:</p>

<ul>
  <li>Using a DSA public key to validate an XML signature made with an RSA-related algorithm.</li>
  <li>Using an RSA public key to validate an XML signature made with a DSA-related algorithm.</li>
  <li>Exhausting available memory while verifying the signature.</li>
</ul>

<p>SimpleSAMLphp supports <strong>only RSA signatures and keys</strong>. Therefore, it is not possible for an attacker to feed an
incorrect context by sending a signature with an incorrect algorithm. Upon reception of a DSA-SHA1 signature,
SimpleSAMLphp will refuse to perform the validation due to the algorithm not being supported. On the other hand, if an
attacker manages to trick a service provider operator to change the public key associated to a certain IdP to a DSA key,
signatures made with any combination of the RSA algorithm will be accepted, regardless of whether they are valid or not.
This means some serious misconfiguration or social engineering is needed in this case for a successful attack.</p>

<p>Regarding memory exhaustion, it is in theory possible to attack a service provider causing the consumption of all
available memory while a message with an invalid signature is being validated. However, memory exhaustion must happen
only during signature validation and not immediately before or after. This means exploitation of this case is extremely
difficult due to the small time window available for the attacker and the precise control that is needed over the
service provider.</p>

<p>All in all, the consequences of this issue are critical, so even though we consider it difficult to exploit, and
considering that other ways to trigger failures in signature validation could be possible but so far unidentified, we
recommend updating the affected software as soon as possible.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the latest versions of the SAML2 library.</p>

<p>For SimpleSAMLphp users, run <code class="language-plaintext highlighter-rouge">composer update</code> or upgrade to SimpleSAMLphp 1.15.4.Refer to the documentation for
instructions on how to <a href="https://simplesamlphp.org/docs/stable/simplesamlphp-install-repo">run composer</a>.</p>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered during a security audit performed by Cure53 and reported on December 18, 2017. Later
on, after the release of version 1.15.3, John Maguire and Adam Goodman of Duo Security discovered and reported the
same issue.</p>

    </main>

<footer>
        <img class="logo" src="/res/ssplogo-fish-2.svg" alt="">
</footer>

  </body>
</html>
