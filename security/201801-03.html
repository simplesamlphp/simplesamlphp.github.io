<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SSPSA 201801-03: Use of insecure connection charset (sqlauth module) - SimpleSAMLphp</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201801-03.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form class="searchbox" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> » SSPSA 201801-03: Use of insecure connection charset (sqlauth module)</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/support/">Support</a>
      </div>
      <div class="menuitem last">
        <a href="/contrib/">Contribute</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px">
    <br style="height: 0px; clear: both">
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning right">
<h2>Date</h2>
January 30, 2018
<h2>Affected versions</h2>
<code>SimpleSAMLphp &lt; 1.15.2</code>
<h2>Severity</h2>
Low
<h2>Reference</h2>
CVE-2018-6521
</div></aside>

<h1 id="201801-03">201801-03</h1>

<p><strong>Use of insecure connection charset (sqlauth module)</strong></p>

<h3 id="background">Background</h3>

<p>The <em>sqlauth</em> module provides an authentication source (<code class="language-plaintext highlighter-rouge">sqlauth:SQL</code>) that allows authenticating users against a
database holding their credentials. This module supports any database backend supported by PDO, including MySQL, and
the use of unicode code points is allowed both for usernames and passwords.</p>

<p>Regarding unicode support, MySQL has long supported the <code class="language-plaintext highlighter-rouge">utf8</code> charset for database, table and column names, as well as
for actual contents and connections. This charset, though, only partially implements UTF-8 encoding, despite its
name.</p>

<h3 id="description">Description</h3>

<p>The <code class="language-plaintext highlighter-rouge">utf8</code> connection charset is used by the <code class="language-plaintext highlighter-rouge">sqlauth:SQL</code> authentication source in the <em>sqlauth</em> module. Due to the
lack of proper support for UTF-8 encoding provided by this charset, encoded symbols that take up four bytes instead of
three or less aren’t supported. This issue, together with the fact that MySQL truncates a query when an unsupported
character is found (in this case, any unicode code point represented with four bytes), could lead to serious security
issues such as authentication bypass, unauthorized database manipulation or stored Cross-Site Scripting attacks.</p>

<p>Two mitigating factors concur in this case, making the issue not exploitable to the best of our knowledge:</p>

<ul>
  <li>The module uses prepared statements to avoid SQL injections. This is an effective countermeasure to avoid SQL query
truncation on unsupported characters.</li>
  <li>The issue is typically exploited with <em>insert</em> or <em>update</em> statements. That would allow an attacker to alter the
HTML output produced by a page and execute arbitrary code on the victim’s browser (stored XSS). This module uses
<em>select</em> statements, effectively removing the possibility to store arbitrary code to be executed.</li>
</ul>

<p>In order to avoid any possible future issues, the connection charset has been changed from <code class="language-plaintext highlighter-rouge">utf8</code> to <code class="language-plaintext highlighter-rouge">utf8mb4</code> when
using a MySQL backend, which implements full unicode support.</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All SimpleSAMLphp versions up to (and including) <strong>1.15.1</strong>.</p>

<h3 id="impact">Impact</h3>

<p>At of the moment of this writing, <strong>there is no known way to exploit the issue</strong> described in this advisory.</p>

<p>However, the issue could be leveraged by an attacker in combination with other unknown issues in order to:</p>

<ul>
  <li>bypass authentication.</li>
  <li>access and modify the contents of the user’s credentials database.</li>
  <li>perform stored Cross-Site Scripting attacks, running arbitrary code in the victim’s web browser.</li>
</ul>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the <a href="/download">latest version</a>.</p>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered during a security audit performed by Cure53 and reported on December 18, 2017.</p>

    </main>

<footer>
        <img class="logo" src="/res/ssplogo-fish-2.svg" alt="">
</footer>

  </body>
</html>
