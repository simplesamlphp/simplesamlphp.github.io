<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SSPSA 201708-01: Invalid token creation and validation</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.github.io/security/201708-01.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.github.io/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form style="margin-top: 2.5rem; margin-right: 2rem" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.github.io" style="color: #fff; text-decoration: none">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar" style="clear: both">
  <p id="breadcrumb"><a href="https://simplesamlphp.github.io">Home</a> » SSPSA 201708-01: Invalid token creation and validation</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/translation/">Translation</a>
      </div>
      <div class="menuitem">
        <a href="/developers/">Developers</a>
      </div>
      <div class="menuitem">
        <a href="https://github.com/simplesamlphp/simplesamlphp/projects">Roadmap</a>
      </div>
      <div class="menuitem">
        <a href="/awards">Awards</a>
      </div>
      <div class="menuitem">
        <a href="/users/">Users</a>
      </div>
      <div class="menuitem">
        <a href="/lists/">Mailing lists</a>
      </div>
      <div class="menuitem last">
        <a href="/support/">Support</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px" />
  <br style="height: 0px; clear: both" />
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>
  <div id="content">

    <aside><div class="sidebar-warning" style="float: right;">
<h2>Date</h2>
August 8, 2017
<h2>Affected versions</h2>
<code>SimpleSAMLphp &lt;= 1.14.14</code>
<h2>Severity</h2>
Medium
<h2>References</h2>
CVE-2017-12867
</div></aside>

<h1 id="201708-01">201708-01</h1>

<p><strong>Invalid token creation and validation</strong></p>

<h3 id="background">Background</h3>

<p>The <code class="language-plaintext highlighter-rouge">SimpleSAML_Auth_TimeLimitedToken</code> class allows the creation and validation of tokens that are valid for a limited
period of time and can be used for authentication purposes. These tokens are used for example by the <em>selfregister</em>
module, both when creating new accounts and when resetting an existing password. The tokens are sent via email as part
of a URL, so that the user in possession of the token is granted access. This is a fairly common mechanism.</p>

<h3 id="description">Description</h3>

<p>A security issue has been found in the way these time-limited tokens are created, allowing for malicious manipulation
so that a token’s validity period can be indefinitely extended.</p>

<p>Tokens are built by prepending a time offset to the token itself, so that this offset can be subtracted from the
current time and get the original time slot when the token was created. While the time slot, the salt used and the
verification data (if any) are authenticated using a hash function, the offset prepended to the token lacks any kind of
authentication. This means an attacker who manages to get an expired token by some means will be able to make the token
valid again by increasing the prepended offset as much as needed to force the validation routine to hit the original
time slot when the token was created on. In other words, tokens created like this are not bound to the current time at
all.</p>

<p>In order to fix it, the offset itself is added to the hash computation, so that a change in the offset produces a new
hash that won’t match, and therefore the token will be considered invalid.</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All <strong>SimpleSAMLphp</strong> versions before and including <strong>1.14.14</strong>.</p>

<h3 id="impact">Impact</h3>

<p>Attackers who manage to get access to expired, secret tokens, may be able to modify them to make them valid again and
use them to impersonate legitimate users.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the <a href="/download">latest version</a>.</p>

    </div>    <!-- /#content -->
</main>


  </body>
</html>
