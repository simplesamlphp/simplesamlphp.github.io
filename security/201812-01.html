<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SSPSA 201812-01: Credentials exposure in session storage - SimpleSAMLphp</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201812-01.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form class="searchbox" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> » SSPSA 201812-01: Credentials exposure in session storage</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/support/">Support</a>
      </div>
      <div class="menuitem last">
        <a href="/contrib/">Contribute</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px">
    <br style="height: 0px; clear: both">
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning right">
<h2>Date</h2>
December 20, 2018
<h2>Affected versions</h2>
<code>SimpleSAMLphp 1.16.0 - 1.16.2</code><br />
<h2>Severity</h2>
Low
</div></aside>

<h1 id="201812-01">201812-01</h1>

<p><strong>Credentials exposure in session storage</strong></p>

<h3 id="background">Background</h3>

<p>In order to implement support for the SAML Enhanced Client or Proxy profile, the credentials obtained for
authentication were stored in the state in order to pass them to the relevant routines. This, however, led to the
credentials being recorded in the user’s session, which can be stored in permanent storage such as the local file
system or a remote memcache or database server.</p>

<h3 id="description">Description</h3>

<p>When an authentication request is received via the ECP profile, the username and password obtained this way were
saved to the state array, which is used to pass relevant data to different routines that may need it. This is not a
problem in itself. However, when the ECP profile is disabled in the Identity Provider, other bindings such as
HTTP-POST or HTTP-Redirect will be used, and since redirections are involved, the state array is then persisted to
the user’s session, effectively storing it in the session backend.</p>

<p>The ECP profile, which uses the SOAP and PAOS bindings, does not involve any HTTP redirection for the user, and for
that reason the state array containing the credentials is never persisted to the session. The logic for determining
when to save the credentials to the state array assumed wrongly, though, that if the authentication request came in
on the SOAP binding, that means the ECP profile is used. This may not be true as ECP can be disabled by configuration
in the IdP’s hosted SAML metadata, and in that case SimpleSAMLphp would then try to default to a binding different
than PAOS, such as HTTP-POST or HTTP-Redirect, effectively consolidating the entire state array to the user’s session
as described before.</p>

<p>In practice, any Identity Provider with the ECP profile disabled but metadata for an entity that supports ECP, would
reject incoming ECP requests, but write the credentials obtained in the request to the user’s session, which will
be stored in the session store, whichever is used (local file system in case PHP sessions are used, Memcache, Redis,
relational databases, etc).</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All SimpleSAMLphp versions 1.16.x are affected, up to <strong>1.16.2</strong>.</p>

<h3 id="impact">Impact</h3>

<p>An Identity Provider with metadata for trusted entities that support the SAML ECP profile, may end up storing the
user’s credentials received from such entities in its own session storage, whatever that is, in case ECP is actually
not enabled in the IdP. Under such circumstances, the credentials may be then accessible to administrators, other
personnel or even malicious parties who may have access to the systems where sessions or their backups are stored.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the latest version of SimpleSAMLphp.</p>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered by Brad Higgins and Jason Baker of Duo Security, and
reported by Steve Manzuik on December 13, 2018.</p>

    </main>


  </body>
</html>
