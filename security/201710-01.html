<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SSPSA 201710-01: Signature validation bypass - SimpleSAMLphp</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201710-01.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form class="searchbox" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> Â» SSPSA 201710-01: Signature validation bypass</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/support/">Support</a>
      </div>
      <div class="menuitem last">
        <a href="/contrib/">Contribute</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px">
    <br style="height: 0px; clear: both">
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning right">
<h2>Date</h2>
October 25, 2017
<h2>Affected versions</h2>
<code>SimpleSAMLphp &lt;= 1.14.16</code>
<h2>Severity</h2>
Critical
<h2>References</h2>
CVE-2017-18122
</div></aside>

<h1 id="201710-01">201710-01</h1>

<p><strong>Signature validation bypass</strong></p>

<h3 id="background">Background</h3>

<p>SAML messages are usually signed to prove the identity of the issuer of the message. In the case of SAML authentication
responses, correctly verifying the signature is critical to trust that the assertion contained inside the response was
issued by a trusted third-party and the identity of the subject has been properly verified.</p>

<p>A SAML message can be signed both at the message level and at the assertion level (if the message is an authentication
response). When the whole authentication response message is unsigned, all the assertions contained inside must be
signed independently in order to verify their authenticity. Failure to properly verify the authenticity of the entire
message or individual assertions leads to the ability of an attacker to impersonate any user from any Identity Provider
trusted by the Service Provider.</p>

<h3 id="description">Description</h3>

<p>A signature validation bypass issue has been found in the <code class="language-plaintext highlighter-rouge">SimpleSAML_XML_Validator</code> class. This class performs the
verification of the XML digital signature of a SAML 1 message with a given key.</p>

<p>When a SAML 1 authentication response message is received, it is processed to verify its authenticity, including a
check for the signature or signatures included in the message. If the message is not signed but the assertions contained
in it are, the signatures of those assertions signed will be verified. Unsigned assertions will not be verified. After
verifying every signed element in the response, a list of valid nodes is built, holding the DOM nodes of those XML
elements that are signed and whose signatures have been successfully verified.</p>

<p>Once this list is built, the assertions need to be processed individually. They are not processed until the
<code class="language-plaintext highlighter-rouge">getAttributes()</code> method of the <code class="language-plaintext highlighter-rouge">SimpleSAML_XML_Shib13_AuthnResponse</code> class is called. This method iterates through the
list of assertions contained in the response and makes sure they were validated in the previous signature verification
step, by checking if their corresponding DOM nodes are in the list of those verified.</p>

<p>The vulnerability is due to lax comparison of the node being checked and the nodes in the verified list. The
<code class="language-plaintext highlighter-rouge">isNodeValidated()</code> method of the <code class="language-plaintext highlighter-rouge">SimpleSAML_XML_Validator</code> class checks if a given DOM node is in the <code class="language-plaintext highlighter-rouge">validNodes</code>
array by means of the standard <code class="language-plaintext highlighter-rouge">in_array()</code> function. This function, however, will return unexpected results due to the
default lax behaviour when checking data types in PHP. In this case, the fact that there is a DOM node in the list is
enough for <code class="language-plaintext highlighter-rouge">in_array()</code> to return <code class="language-plaintext highlighter-rouge">true</code> when looking for any DOM node. This means any unsigned assertion will be
considered <em>verified</em> if there is at least one assertion with a valid signature in the message being processed.</p>

<p>This issue allows an attacker to generate a SAML 1 authentication response that contains two different assertions. The
first assertion is the one the attacker wants the Service Provider to use, with custom attributes, expiration and even
<em>entityID</em> (provided that the given <em>entityID</em> belongs to an Identity Provider that the Service Provider knows and
trusts). The second is a legitimate assertion issued and signed by an Identity Provider trusted by the Service Provider.
If the second assertion is still valid when sent by the attacker, SimpleSAMLphp will merge all the attributes found in
both assertions, but the <em>entityID</em> registered for the authenticating third-party will be the one found in the first,
tampered assertion. If the second (legitimate) assertion is already expired when the attacker sends it, only the
attributes found in the tampered assertion will be used.</p>

<p>The issue can be easily fixed by passing a third parameter to the <code class="language-plaintext highlighter-rouge">in_array()</code> function, telling it to perform strict
comparisons when checking if an object is found inside a given array. This way, when the code evaluates if the tampered
assertion is included in the list of verified assertions, it fails and only the legitimate assertion is used, if
possible (e.g. it is not expired).</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All <strong>SimpleSAMLphp</strong> versions before and including <strong>1.14.16</strong>.</p>

<h3 id="impact">Impact</h3>

<p>An attacker can leverage this vulnerability to impersonate any user from any SAML 1 Identity Provider trusted by a
SimpleSAMLphp Service Provider, with the only pre-requisite of a valid assertion previously sent to the affected
Service Provider. As such, only those SimpleSAMLphp installations that have metadata deployed for SAML 1 Identity
Providers (by default, listed in the <code class="language-plaintext highlighter-rouge">metadata/shib13-idp-remote.php</code> file, but could be in other locations depending on
your local configuration) are affected.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the <a href="/download">latest version</a>. When an upgrade is not possible immediately, the following patch must be
applied:</p>

<pre>
diff --git a/lib/SimpleSAML/XML/Validator.php b/lib/SimpleSAML/XML/Validator.php
index e4877f0..69236ef 100644
--- a/lib/SimpleSAML/XML/Validator.php
+++ b/lib/SimpleSAML/XML/Validator.php
@@ -260,7 +260,7 @@ class SimpleSAML_XML_Validator {
                assert('$node instanceof DOMNode');

                while($node !== NULL) {
-                       if(in_array($node, $this-&gt;validNodes)) {
+                       if(in_array($node, $this-&gt;validNodes, true)) {
                                return TRUE;
                        }

</pre>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered and reported on October 22, 2017 by Matt Schwager.</p>

    </main>

<footer>
        <img class="logo" src="/res/ssplogo-fish-2.svg" alt="">
</footer>

  </body>
</html>
