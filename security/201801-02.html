<!DOCTYPE html>
<html lang="en">
  <head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Language" content="en">
  <meta name="google-site-verification" content="2S8M18BgYs8cLRL6ClTrfW_xGxfFtMZu2b2jhjrNlss">

  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>SSPSA 201801-02: Open redirection protection bypass</title>
  <meta name="description" content="SimpleSAMLphp** is an award-winning application written in native PHP that deals with authentication. It implements support for multiple protocols, most notably SAML, OpenID or OAuth.">

  <link rel="stylesheet" href="/res/css/style.css">
  <link rel="stylesheet" href="/res/css/layout.css">
  <link rel="canonical" href="https://simplesamlphp.org/security/201801-02.html">
  <link rel="alternate" type="application/rss+xml" title="SimpleSAMLphp" href="https://simplesamlphp.org/feed.xml">
</head>

  <body>
      <!-- Red logo header -->
  <header>
  <div id="header">
    <div class="right">
      <form style="margin-top: 2.5rem; margin-right: 2rem" method="get" action="https://www.google.com/cse">
        <input type="hidden" name="cx" value="004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="siteurl" value="www.google.com/cse/home?cx=004202914224971217557:8ks4jjstupq" />
        <input type="hidden" name="adkw" value="AELymgVJ6Sk-kOvUjbxvgShTLwiFlma2evFuVCh0r8q23vn_4eVnkcdnPfbgMvYUTpJpVlb-KkGAKkbn0i-AlWHsVRR9O0J4CNb6cXFkEKRdjXxsC_NlVD4" />
        <input type="search" name="q" placeholder="Search" value="" />
      </form>
    </div>
    <div class="v-center logo-header">
      <div id="logo">
        <a href="https://simplesamlphp.org" style="color: #fff; text-decoration: none">
          <span class="simple">Simple</span>
          <span class="saml">SAML</span>
          <span class="simple">php</span>
        </a>
      </div>
    </div>
    
  </div>

  <!-- Grey header bar below -->
  <nav>
  <div id="headerbar" style="clear: both">
  <p id="breadcrumb"><a href="https://simplesamlphp.org">Home</a> » SSPSA 201801-02: Open redirection protection bypass</p>
    <div class="mtoolbar">
      <div class="menuitem first">
        <a href="/download">Download</a>
      </div>
      <div class="menuitem">
        <a href="/docs">Documentation</a>
      </div>
      <div class="menuitem">
        <a href="/security">Security</a>
      </div>
      <div class="menuitem">
        <a href="/modules/">Modules</a>
      </div>
      <div class="menuitem">
        <a href="/translation/">Translation</a>
      </div>
      <div class="menuitem">
        <a href="/developers/">Developers</a>
      </div>
      <div class="menuitem">
        <a href="https://github.com/simplesamlphp/simplesamlphp/projects">Roadmap</a>
      </div>
      <div class="menuitem">
        <a href="/awards">Awards</a>
      </div>
      <div class="menuitem">
        <a href="/users/">Users</a>
      </div>
      <div class="menuitem">
        <a href="/lists/">Mailing lists</a>
      </div>
      <div class="menuitem last">
        <a href="/support/">Support</a>
      </div>
    </div>
    <br style="clear: both; height: 0px; width: 0px" />
  <br style="height: 0px; clear: both" />
  </div><!-- /#headerbar -->
  </nav>
  </header>

  <main>

    <aside><div class="sidebar-warning" style="float: right;">
<h2>Date</h2>
January 29, 2018
<h2>Affected versions</h2>
<code>SimpleSAMLphp &lt; 1.15.2</code>
<h2>Severity</h2>
Low
<h2>Reference</h2>
CVE-2018-6520
</div></aside>

<h1 id="201801-02">201801-02</h1>

<p><strong>Open redirection protection bypass</strong></p>

<h3 id="background">Background</h3>

<p>An open redirection issue happens when a web application performs a redirection to a URL obtained from user input
without proper validation. Such an issue allows attackers to craft URLs pointing to a trusted web site which will then
redirect to another page under the control of the attacker. This is usually used to give phishing attacks the
appearance of legitimacy, making it easier to trick victims into following a link.</p>

<p>SimpleSAMLphp 1.12.0 introduced a whitelisting mechanism to address multiple open redirection issues scattered around
its code. This whitelisting mechanism enforces the need to manually specify all domains that should be allowed when a
redirection happens to a user-provided URL, by means of the <code class="language-plaintext highlighter-rouge">trusted.url.domains</code> and <code class="language-plaintext highlighter-rouge">trusted.url.regex</code> configuration
options. In order to make it as transparent as possible, the very same host where SimpleSAMLphp is running and all hosts
found in remote metadata are automatically whitelisted, so that in practice, adding domain names to the white list
shouldn’t be necessary.</p>

<h3 id="description">Description</h3>

<p>The particular implementation of this whitelisting mechanism was using a regular expression to validate user-provided
URLs and extract the host information to search for it in the white list. This regular expression had an issue that
allowed an attacker to build a URL that passed the whitelisting validation, while still being redirected by the web
browser to a different URL under their control. The regular expression was not properly taking into account the
<em>authority</em> part of the URL, so that its contents could be taken as the host to check against the white list, and the
actual host as seen by the browser would be ignored, effectively skipping the validation.</p>

<p>The standard <code class="language-plaintext highlighter-rouge">parse_url()</code> PHP function is now used instead of a regular expression to validate and parse user-provided
URLs. This function, as it was later brought to our attention, is strict with regard to regular slashes and backslashes,
while most web browsers transform the latter into the former automatically. Therefore, as an additional validation
mechanism, all URLs containing an <em>authority</em> part with a backslash character are now regarded as invalid, leading to an
exception.</p>

<h3 id="affected-versions">Affected versions</h3>

<p>All SimpleSAMLphp versions <strong>between 1.12.0 and 1.15.1</strong>, both included.</p>

<h3 id="impact">Impact</h3>

<p>An attacker may be able to manually craft URLs that could bypass the whitelisting validation mechanism and take
advantage of the multiple endpoints in SimpleSAMLphp where a redirection is performed to a user-provided URL. This can
be used to perform phishing attacks by providing inconspicuous links that appear legitimate to most users.</p>

<p>A mitigating factor is that some popular web browsers alert end users when performing a redirection to a URL
that includes a username and password, making the attack less transparent and allowing the victim realize about it.</p>

<h3 id="resolution">Resolution</h3>

<p>Upgrade to the <a href="/download">latest version</a>.</p>

<h3 id="credit">Credit</h3>

<p>This security issue was discovered during a security audit performed by Cure53 and reported on December 18, 2017.</p>

<p>A report detailing further issues in the initial fix was submitted by Juho Nurminen on January 16, 2018.</p>

    </main>


  </body>
</html>
